{% extends "base.html" %}

{# Updated Title for Branding #}
{% block title %}Unsorted Media - SCR Property Manager{% endblock %}

{% block head_extra %}
<style>
  .unsorted-grid { display: flex; flex-wrap: wrap; gap:1rem; }
  /* Original .unsorted-item styles are commented out for the debug view */
  /*
  .unsorted-item {
    border:1px solid #444; border-radius:4px;
    padding:.5rem; width:150px;
    background: #1e2226;
    color: #eee;
    display: flex;
    flex-direction: column;
  }
  .unsorted-item img {
    width:100%; height:100px;
    object-fit:cover; border-radius:4px;
    margin-bottom: 0.5rem;
  }
  .unsorted-item .info { font-size:.75rem; margin: .25rem 0; }
  .unsorted-item form { margin-top: auto; }
  */

  /* Simple style for the debug container */
  .debug-item {
    border: 1px dashed lime;
    margin: 5px;
    padding: 5px;
    background: #333;
    width: 150px; /* Give it some width */
  }
  .debug-item p {
      word-wrap: break-word; /* Wrap long paths */
  }
   .debug-item img {
      width: 100px;
      height: 100px;
      border: 2px solid red;
      display: block;
      background-color: #555; /* Background for broken image */
      color: white; /* Text color for alt text */
      text-align: center;
      font-size: 10px;
      line-height: 100px; /* Center alt text vertically */
  }

</style>
{% endblock %}

{% block content %}
  {# Updated Heading for Branding #}
  <h2 class="mb-3">Unsorted Media (Debug View)</h2> {# Added (Debug View) #}
  <p class="text-muted mb-4">Media from messages not yet assigned to a property. Assign them below.</p> {# Added description #}

  {% if error %} {# Display error passed from route if any #}
    <div class="alert alert-danger" role="alert">
      Error loading unsorted media: {{ error }}
    </div>
  {% endif %}

  {% if unsorted %}
    <div class="unsorted-grid">

      {# --- TEMPORARY DEBUG LOOP --- #}
      {% for u in unsorted %} {# u is {'path': 'uploads/...', 'msg': <Message>} #}
        <div class="debug-item"> {# Use debug style class #}
          {# Display the raw path and generated src for debugging #}
          <p style="color: white; font-size: 10px; margin: 0;">
             Raw Path: {{ u.path }}<br>
             Generated Src: {{ url_for('serve_upload', filename=u.path.split('/')[-1]) }}
          </p>
          {# Minimal image tag with border #}
          <img src="{{ url_for('serve_upload', filename=u.path.split('/')[-1]) }}"
               alt="Test Img (Msg {{ u.msg.id }})" {# Simplified Alt Text #}
               style="width: 100px; height: 100px; border: 2px solid red; display: block;">
          {# Display other info if needed #}
          <p style="color: cyan; font-size: 10px; margin: 2px 0 0 0;">
              Msg #{{ u.msg.id }} | {{ u.msg.contact.contact_name or u.msg.phone_number }}
          </p>
           {# Keep form for assigning - optional during debug #}
           <form method="POST" action="{{ url_for('assign_property') }}" style="margin-top: 5px;">
             <input type="hidden" name="message_id" value="{{ u.msg.id }}">
             <select name="property_id" class="form-select form-select-sm mb-1" required>
               <option value="">– Select property –</option>
               {% for prop in properties %}
                 <option value="{{ prop.id }}">{{ prop.name }}</option>
               {% endfor %}
             </select>
             <button class="btn btn-sm btn-primary w-100">Assign</button>
           </form>
        </div>
      {% endfor %}
      {# --- END TEMPORARY DEBUG LOOP --- #}

    </div>
  {% else %}
    {# Only show this if there wasn't an error message #}
    {% if not error %}
      <p class="text-muted">No unassigned images found.</p>
    {% endif %}
  {% endif %}
{% endblock %}
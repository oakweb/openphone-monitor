{% extends 'base.html' %}

{% block title %}Recent Messages{% endblock %}

{% block head_extra %}
    <style>
        /* Styles specifically for the messages list items */
        main .card { margin-bottom: 1rem; }
        #messagesList .list-group-item {
            padding: 0;
            background-color: #2c3035;
            border-bottom: 1px solid #3a8bab !important;
            color: #fff;
        }
         .list-group-flush > .list-group-item { border-width: 0 0 1px; }
         .list-group-flush:last-child .list-group-item:last-child { border-bottom-width: 0; }
        .message-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem 1rem; background-color: #2c3035;
            border-bottom: 1px solid rgba(58, 139, 171, 0.3);
        }
         .message-header strong { color: #e9ecef; }
         .message-header .text-muted.small { font-size: 0.8em; color: #adb5bd !important;}
        .message-body {
            padding: 0.75rem 1rem 1rem 1rem; background: #1e2226;
        }
        .message-text {
            margin: 0.5rem 0; white-space: pre-wrap; word-wrap: break-word;
        }
        .message-link {
            color: #6cb9d3; text-decoration: underline; margin: 0.5rem 0;
            display: block; word-break: break-all;
        }
        .message-media img {
            max-width: 100%; max-height: 200px; border-radius: 6px;
            margin: 0.5rem 0; border: 1px solid #3a8bab;
        }
        .add-contact-section {
            padding: 0.75rem 1rem; background-color: rgba(58, 139, 171, 0.1);
            border-top: 1px dashed rgba(58, 139, 171, 0.4); margin-top: -1px;
        }
        .add-contact-section .form-control {
             background-color: rgba(30, 40, 50, 0.7);
             border: 1px solid rgba(108, 185, 211, 0.3); color: #fff;
         }
         .controls { gap: 0.5rem; flex-wrap: wrap;} /* Added wrap */
         .controls select, .controls button { padding: 0.375rem 0.75rem; }
         @media (max-width: 576px) {
            .controls { justify-content: center;}
            .controls button { margin-left: 0; width: 100%; margin-top: 0.5rem;}
        }
    </style>
{% endblock %} {# End head_extra block #}


{% block content %}
    {# Removed Home button as it's in navbar now #}
    <div class="controls mb-3">
        <select id="sortOrder" class="form-select form-select-sm" style="max-width: 150px;">
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
        </select>
        <select id="filterBy" class="form-select form-select-sm" style="max-width: 150px;">
            <option value="all">All Messages</option>
            <option value="today">Today Only</option>
        </select>
        <button id="refreshBtn" class="btn btn-success btn-sm">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>

    <div class="card">
        <ul id="messagesList" class="list-group list-group-flush">
             {% if messages and messages|length > 0 %}
                 {% for msg in messages %}
                     {% set is_known = known_contact_phones is defined and msg.phone_number in known_contact_phones %}
                     <li class="list-group-item" data-timestamp="{{ msg.timestamp.isoformat() }}">
                         <div class="message-header">
                             <div><i class="fas fa-user-circle me-2"></i><strong>{{ msg.contact_name or msg.phone_number }}</strong></div>
                             <span class="text-muted small">{{ msg.timestamp.strftime('%m-%d %H:%M') }}</span>
                         </div>
                         <div class="message-body">
                             <p class="message-text">{{ msg.message }}</p>
                             {% if msg.media_urls %}
                                 {% set urls = msg.media_urls.split(',') %}
                                 {% for url in urls %}
                                     {% if url %} {# Check if url is not empty #}
                                         <div class="message-media">
                                             {# ALWAYS try to render an img tag #}
                                             <img src="{{ url }}" class="img-fluid" style="max-height: 200px;"
                                                  onerror="this.onerror=null;this.style.display='none'; this.alt='Attachment (cannot display inline)';"> {# Hide on error, add alt text #}
                                         </div>
                                     {% endif %}
                                 {% endfor %}
                             {% endif %}
                         </div>

                         {% if not is_known %}
                         <div class="add-contact-section">
                             <form method="POST" action="{{ url_for('contacts_view') }}" class="d-flex gap-2">
                                 <input type="hidden" name="phone" value="{{ msg.phone_number }}">
                                 <input type="text" name="name" placeholder="Enter name to add" class="form-control form-control-sm" required style="flex-grow: 1;">
                                 <button type="submit" name="action" value="add" class="btn btn-success btn-sm flex-shrink-0">
                                     <i class="fas fa-user-plus"></i> Add
                                 </button>
                             </form>
                         </div>
                         {% endif %}
                         </li> {# End list-group-item #}
                 {% endfor %} {# End message loop #}
             {% else %}
                 <li class="list-group-item text-center text-muted p-3">No messages found</li>
             {% endif %} {# End if messages #}
         </ul>
     </div>
{% endblock %} {# End content block #}

{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const refreshBtn = document.getElementById('refreshBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => window.location.reload());
            }
            const sortOrderSelect = document.getElementById('sortOrder');
            if (sortOrderSelect) {
                sortOrderSelect.addEventListener('change', function() {
                    const order = this.value;
                    const list = document.getElementById('messagesList');
                    if (!list) return;
                    const items = Array.from(list.children);
                    items.forEach(item => list.removeChild(item));
                    items.sort((a, b) => {
                        const tsA = a.dataset.timestamp ? new Date(a.dataset.timestamp) : null;
                        const tsB = b.dataset.timestamp ? new Date(b.dataset.timestamp) : null;
                        if (!tsA && !tsB) return 0; if (!tsA) return 1; if (!tsB) return -1;
                        return order === 'newest' ? tsB - tsA : tsA - tsB;
                    }).forEach(item => list.appendChild(item));
                });
                 sortOrderSelect.dispatchEvent(new Event('change'));
            }
            const filterBySelect = document.getElementById('filterBy');
            if (filterBySelect) {
                filterBySelect.addEventListener('change', function() {
                    const crit = this.value;
                    const todayStart = new Date().setHours(0, 0, 0, 0);
                    document.querySelectorAll('#messagesList .list-group-item').forEach(item => {
                        let show = true;
                        const ts = item.dataset.timestamp ? new Date(item.dataset.timestamp).getTime() : null;
                        if (crit === 'today') { show = (ts !== null && ts >= todayStart); }
                        item.style.display = show ? '' : 'none';
                    });
                });
                 filterBySelect.dispatchEvent(new Event('change'));
            }
        });
    </script>
{% endblock %} {# End scripts block #}
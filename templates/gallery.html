{% extends "base.html" %}

{% block title %}
  {# Use the gallery_title variable passed from Python, or fallback #}
  {{ gallery_title | default('Image Gallery') }} - SCR Property Manager {# Added Branding #}
{% endblock %}

{% block head_extra %}
  <style>
    /* thumbnail grid wrapper */
    .gallery {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem; /* Space between images */
      justify-content: flex-start; /* Align items to the start */
      padding: 1rem 0; /* Remove horizontal padding, keep vertical */
    }

    /* each thumbnail box */
    .image-wrapper {
      position: relative; /* Needed for absolute positioning of the delete button */
      width: 150px; /* Fixed width */
      height: 150px; /* Fixed height */
      overflow: hidden; /* Hide parts of image that don't fit */
      border: 1px solid #444; /* Match unsorted border */
      border-radius: 4px;
      background-color: #212529; /* Darker background */
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ccc; /* Light text for potential errors */
    }

    /* image fills the box */
    .image-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover; /* Scale image nicely while maintaining aspect ratio */
      display: block; /* Remove extra space below image */
      transition: transform 0.2s ease-in-out; /* Smooth zoom effect on hover */
    }
    .image-wrapper a:hover img {
        transform: scale(1.05); /* Slight zoom on hover */
    }

    /* position delete button on top-right corner */
    .image-wrapper .delete-form { /* Target the form specifically */
      position: absolute;
      top: 5px;
      right: 5px;
      z-index: 10; /* Ensure button is above image */
      opacity: 0.8; /* Make it slightly transparent */
      transition: opacity 0.2s ease-in-out;
    }
     .image-wrapper:hover .delete-form {
        opacity: 1; /* Fully opaque on hover */
      }

    .delete-form button {
        padding: 0.2rem 0.4rem; /* Smaller padding */
        font-size: 0.75rem; /* Smaller font */
        line-height: 1; /* Adjust line height */
    }

    /* Style for the link */
    .image-wrapper a {
        display: block;
        width: 100%;
        height: 100%;
    }
  </style>
{% endblock %}

{% block content %}
  <h2 class="mb-3"> {# Added margin-bottom #}
    {# Use the gallery_title variable passed from Python #}
    {{ gallery_title | default('Image Gallery') }}
  </h2>

  {# Check if the CORRECT variable image_items exists and is not empty #}
  {% if image_items %}
    <div class="gallery">
      {# Loop through the CORRECT variable image_items #}
      {% for img_item in image_items %} {# img_item is {'path': 'uploads/...', 'sender_info': ..., etc} #}
        <div class="image-wrapper">
          {# *** MODIFIED A HREF and IMG SRC *** #}
          {# Use url_for('serve_upload') and extract filename for BOTH #}
          <a href="{{ url_for('serve_upload', filename=img_item.path.split('/')[-1]) }}" target="_blank" title="View full image (from {{ img_item.sender_info }})">
            <img src="{{ url_for('serve_upload', filename=img_item.path.split('/')[-1]) }}"
                 alt="Gallery image from {{ img_item.sender_info }}" {# Updated Alt Text #}
                 {# Add basic error handling for missing images client-side #}
                 onerror="this.onerror=null; this.parentElement.style.display='none'; console.error('Failed to load image: {{ img_item.path }}');">
          </a>

          {# --- Delete form remains commented out --- #}
          {#
          <form class="delete-form"
                action="{{ url_for('delete_media_for_message', message_id=img_item.message_id, file_index=img_item.index) }}"
                method="POST"
                onsubmit="return confirm('Are you sure you want to delete this image? This cannot be undone.');">
            <button type="submit" class="btn btn-danger btn-sm" title="Delete this image">
                &times;
            </button>
          </form>
          #}
          {# --- End commented out delete form --- #}

        </div>
      {% endfor %}
    </div>
  {% else %}
    {# This message shows if image_items is empty or not passed #}
    <p class="text-muted">No images found for this gallery.</p> {# Added text-muted class #}
    {% if error %}
       <div class="alert alert-warning" role="alert">
         Error loading gallery: {{ error }}
       </div>
    {% endif %}
  {% endif %}

  {# Optional: Link back to property detail or gallery overview if applicable #}
  {% if property %} {# Check if the property object was passed #}
     <div class="mt-4"> {# Removed text-center #}
         <a href="{{ url_for('property_detail_view', property_id=property.id) }}" class="btn btn-outline-secondary btn-sm me-2">&laquo; Back to Property Details</a>
         <a href="{{ url_for('galleries_overview') }}" class="btn btn-outline-secondary btn-sm">&laquo; Back to Galleries Overview</a> {# Changed link target #}
     </div>
  {% else %}
      {# Maybe add a link back to a general gallery overview if this template is used elsewhere #}
      <div class="mt-4">
          <a href="{{ url_for('galleries_overview') }}" class="btn btn-outline-secondary btn-sm">&laquo; Back to Galleries Overview</a>
      </div>
  {% endif %}

{% endblock %}
{% extends "base.html" %}

{% block title %}
  {# Use the gallery_title variable passed from Python, or fallback #}
  {{ gallery_title | default('Image Gallery') }}
{% endblock %}

{% block head_extra %}
  <style>
    /* thumbnail grid wrapper */
    .gallery {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem; /* Space between images */
      justify-content: flex-start; /* Align items to the start */
      padding: 1rem; /* Add some padding around the gallery */
    }

    /* each thumbnail box */
    .image-wrapper {
      position: relative; /* Needed for absolute positioning of the delete button */
      width: 150px; /* Fixed width */
      height: 150px; /* Fixed height */
      overflow: hidden; /* Hide parts of image that don't fit */
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #f8f9fa; /* Light background for placeholders */
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* image fills the box */
    .image-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover; /* Scale image nicely while maintaining aspect ratio */
      display: block; /* Remove extra space below image */
      transition: transform 0.2s ease-in-out; /* Smooth zoom effect on hover */
    }
    .image-wrapper a:hover img {
        transform: scale(1.05); /* Slight zoom on hover */
    }

    /* position delete button on top-right corner */
    .image-wrapper .delete-form { /* Target the form specifically */
      position: absolute;
      top: 5px;
      right: 5px;
      z-index: 10; /* Ensure button is above image */
      opacity: 0.8; /* Make it slightly transparent */
      transition: opacity 0.2s ease-in-out;
    }
     .image-wrapper:hover .delete-form {
         opacity: 1; /* Fully opaque on hover */
     }

    .delete-form button {
        padding: 0.2rem 0.4rem; /* Smaller padding */
        font-size: 0.75rem; /* Smaller font */
        line-height: 1; /* Adjust line height */
    }

    /* Style for the link */
    .image-wrapper a {
        display: block;
        width: 100%;
        height: 100%;
    }
  </style>
{% endblock %}

{% block content %}
  <h2>
    {# Use the gallery_title variable passed from Python #}
    {{ gallery_title | default('Image Gallery') }}
  </h2>

  {# Check if the CORRECT variable image_items exists and is not empty #}
  {% if image_items %}
    <div class="gallery">
      {# Loop through the CORRECT variable image_items #}
      {% for img_item in image_items %}
        <div class="image-wrapper">
          {# Use img_item.path to get the relative path for the image #}
          <a href="{{ url_for('static', filename=img_item.path) }}" target="_blank" title="View full image">
            {# Also use img_item.path for the src attribute #}
            <img src="{{ url_for('static', filename=img_item.path) }}"
                 alt="Gallery image from message {{ img_item.message_id }}"
                 {# Add basic error handling for missing images client-side #}
                 onerror="this.onerror=null; this.parentElement.style.display='none'; console.error('Failed to load image: {{ img_item.path }}');">
          </a>
          {# Correct the form action and add necessary hidden fields #}
          <form class="delete-form"
                action="{{ url_for('delete_media_for_message', message_id=img_item.message_id, file_index=img_item.index) }}"
                method="POST"
                onsubmit="return confirm('Are you sure you want to delete this image? This cannot be undone.');">
            {# No need to send file_path, the route uses message_id and index #}
            <button type="submit" class="btn btn-danger btn-sm" title="Delete this image">
                {# Use a simple 'X' or trash icon if using FontAwesome etc. #}
                &times;
            </button>
          </form>
        </div>
      {% endfor %}
    </div>
  {% else %}
    {# This message shows if image_items is empty or not passed #}
    <p>No images found for this gallery.</p>
    {% if error %}
       <div class="alert alert-warning" role="alert">
         Error loading gallery: {{ error }}
       </div>
    {% endif %}
  {% endif %}

{% endblock %}
